import React, { useState, useEffect } from 'react';

// Main App Component
const App = () => {
  // State for Audit Information
  const [auditInfo, setAuditInfo] = useState({
    date: '',
    startTime: '',
    endTime: '',
    auditor: '',
    area: '',
    riskLevel: '', // 'high', 'medium', 'low'
    overallSuggestions: '',
  });

  // State for Checklist Items
  const [checklistItems, setChecklistItems] = useState([
    // Section 1: Raw Material Receiving & Storage
    { id: '1.1', section: 'การรับและจัดเก็บวัตถุดิบ', description: 'วัตถุดิบทุกชนิดถูกตรวจสอบคุณภาพและปริมาณเมื่อรับเข้าตาม SOP-BOH-001 และ SOP-BOH-009', status: '', observations: '' },
    { id: '1.2', section: 'การรับและจัดเก็บวัตถุดิบ', description: 'วัตถุดิบแช่เย็น/แช่แข็ง มีอุณหภูมิอยู่ในเกณฑ์ที่กำหนดเมื่อรับเข้า (≤4°C สำหรับแช่เย็น, ≤-18°C สำหรับแช่แข็ง)', status: '', observations: '' },
    { id: '1.3', section: 'การรับและจัดเก็บวัตถุดิบ', description: 'วัตถุดิบทุกชิ้นมีการติดฉลากระบุชื่อ, วันที่รับเข้า, และวันหมดอายุอย่างชัดเจน', status: '', observations: '' },
    { id: '1.4', section: 'การรับและจัดเก็บวัตถุดิบ', description: 'วัตถุดิบถูกจัดเก็บในพื้นที่ที่เหมาะสม (เช่น ตู้เย็น, ตู้แช่แข็ง, ห้องเก็บแห้ง) ทันทีหลังรับเข้า', status: '', observations: '' },
    { id: '1.5', section: 'การรับและจัดเก็บวัตถุดิบ', description: 'มีการจัดเก็บวัตถุดิบสูงจากพื้นอย่างน้อย 15 ซม. และห่างจากผนังตาม SOP-BOH-007', status: '', observations: '' },
    { id: '1.6', section: 'การรับและจัดเก็บวัตถุดิบ', description: 'มีการแยกเก็บอาหารดิบและปรุงสุกออกจากกันเพื่อป้องกันการปนเปื้อนข้าม', status: '', observations: '' },
    { id: '1.7', section: 'การรับและจัดเก็บวัตถุดิบ', description: 'มีการหมุนเวียนสต็อกตามหลัก FIFO/FEFO อย่างเคร่งครัด (ตรวจสอบวันหมดอายุ)', status: '', observations: '' },

    // Section 2: Food Preparation & Cooking
    { id: '2.1', section: 'การเตรียมและการปรุงอาหาร', description: 'พื้นที่เตรียมอาหารสะอาด เป็นระเบียบ และปราศจากสิ่งปนเปื้อนก่อนเริ่มงาน', status: '', observations: '' },
    { id: '2.2', section: 'การเตรียมและการปรุงอาหาร', description: 'มีดและเขียงที่มีรหัสสีถูกใช้งานอย่างถูกต้องตามประเภทวัตถุดิบ (เนื้อ, ผัก, อื่นๆ)', status: '', observations: '' },
    { id: '2.3', section: 'การเตรียมและการปรุงอาหาร', description: 'การเตรียมวัตถุดิบ (Mise en Place) ถูกทำอย่างถูกสุขอนามัยและรวดเร็ว', status: '', observations: '' },
    { id: '2.4', section: 'การเตรียมและการปรุงอาหาร', description: 'การปรุงอาหารแต่ละประเภทเป็นไปตามสูตรมาตรฐาน (อ้างอิง SOP-BOH-002)', status: '', observations: '' },
    { id: '2.5', section: 'การเตรียมและการปรุงอาหาร', description: 'อาหารที่ปรุงสุกมีอุณหภูมิภายในที่ปลอดภัยตามมาตรฐาน (เช่น เนื้อสัตว์ปีก ≥74°C)', status: '', observations: '' },
    { id: '2.6', section: 'การเตรียมและการปรุงอาหาร', description: 'มีการระบายอากาศที่เหมาะสมในบริเวณครัว เพื่อลดความร้อนและควัน', status: '', observations: '' },

    // Section 3: Personal Hygiene
    { id: '3.1', section: 'สุขอนามัยส่วนบุคคล', description: 'พนักงานทุกคนแต่งกายสะอาด สวมชุดยูนิฟอร์มที่สะอาด และสวมหมวก/ตาข่ายคลุมผม', status: '', observations: '' },
    { id: '3.2', section: 'สุขอนามัยส่วนบุคคล', description: 'พนักงานล้างมืออย่างถูกต้องและสม่ำเสมอ (ก่อนเริ่มงาน, หลังเข้าห้องน้ำ, หลังสัมผัสของสกปรก)', status: '', observations: '' },
    { id: '3.3', section: 'สุขอนามัยส่วนบุคคล', description: 'พนักงานสวมถุงมือที่สะอาดและเหมาะสมเมื่อสัมผัสอาหารพร้อมทานหรือวัตถุดิบที่ต้องดูแลเป็นพิเศษ', status: '', observations: '' },
    { id: '3.4', section: 'สุขอนามัยส่วนบุคคล', description: 'พนักงานไม่มีอาการป่วยที่อาจส่งผลต่อความปลอดภัยอาหาร (เช่น ไอ, จาม, ท้องเสีย) ขณะปฏิบัติงาน', status: '', observations: '' },
    { id: '3.5', section: 'สุขอนามัยส่วนบุคคล', description: 'มีการจัดการสุขอนามัยเล็บและเครื่องประดับอย่างถูกต้องตามนโยบาย', status: '', observations: '' },

    // Section 4: Cleaning & Sanitation
    { id: '4.1', section: 'การทำความสะอาดและสุขาภิบาล', description: 'มีตารางการทำความสะอาดประจำวัน/รายสัปดาห์/รายเดือน และพนักงานปฏิบัติตามอย่างเคร่งครัด', status: '', observations: '' },
    { id: '4.2', section: 'การทำความสะอาดและสุขาภิบาล', description: 'อุปกรณ์ครัวและพื้นผิวสัมผัสอาหารทั้งหมดถูกทำความสะอาดและฆ่าเชื้ออย่างถูกต้องตาม SOP-BOH-005', status: '', observations: '' },
    { id: '4.3', section: 'การทำความสะอาดและสุขาภิบาล', description: 'พื้นครัวสะอาด แห้ง และปราศจากสิ่งกีดขวาง (น้ำ, น้ำมัน, เศษอาหาร)', status: '', observations: '' },
    { id: '4.4', section: 'การทำความสะอาดและสุขาภิบาล', description: 'มีการจัดเก็บอุปกรณ์ทำความสะอาดอย่างเป็นระเบียบและถูกสุขอนามัย', status: '', observations: '' },
    { id: '4.5', section: 'การทำความสะอาดและสุขาภิบาล', description: 'ห้องน้ำพนักงานสะอาด ถูกสุขอนามัย และมีอุปกรณ์ล้างมือครบถ้วน', status: '', observations: '' },

    // Section 5: Waste Management
    { id: '5.1', section: 'การจัดการขยะและของเสีย', description: 'มีถังขยะเพียงพอและแยกประเภทขยะอย่างชัดเจน (เศษอาหาร, รีไซเคิล, ทั่วไป)', status: '', observations: '' },
    { id: '5.2', section: 'การจัดการขยะและของเสีย', description: 'ถังขยะมีฝาปิดมิดชิด และถูกนำไปทิ้ง/ทำความสะอาดเป็นประจำทุกวันตาม SOP-BOH-004', status: '', observations: '' },
    { id: '5.3', section: 'การจัดการขยะและของเสีย', description: 'มีการจัดการน้ำมันใช้แล้วอย่างถูกวิธี ไม่มีการทิ้งลงท่อระบายน้ำ', status: '', observations: '' },
    { id: '5.4', section: 'การจัดการขยะและของเสีย', description: 'พื้นที่จัดเก็บขยะสะอาดและปราศจากสัตว์พาหะ', status: '', observations: '' },

    // Section 6: Temperature Control
    { id: '6.1', section: 'การควบคุมอุณหภูมิ', description: 'มีการบันทึกอุณหภูมิตู้เย็น/ตู้แช่แข็ง/ไลน์บุฟเฟต์อย่างสม่ำเสมอและอยู่ในเกณฑ์ที่ปลอดภัย', status: '', observations: '' },
    { id: '6.2', section: 'การควบคุมอุณหภูมิ', description: 'อาหารที่ต้องควบคุมอุณหภูมิถูกจัดเก็บในอุณหภูมิที่ถูกต้องตลอดเวลา (Cold/Hot Holding)', status: '', observations: '' },
    { id: '6.3', section: 'การควบคุมอุณหภูมิ', description: 'มีการใช้เทอร์โมมิเตอร์ที่สอบเทียบแล้วในการวัดอุณหภูมิอาหารและอุปกรณ์', status: '', observations: '' },

    // Section 7: Cross-Contamination Prevention
    { id: '7.1', section: 'การป้องกันการปนเปื้อนข้าม', description: 'มีการแยกพื้นที่/อุปกรณ์สำหรับวัตถุดิบดิบและอาหารปรุงสุกอย่างชัดเจน', status: '', observations: '' },
    { id: '7.2', section: 'การป้องกันการปนเปื้อนข้าม', description: 'พนักงานเปลี่ยนถุงมือหรือล้างมือเมื่อเปลี่ยนจากการจัดการวัตถุดิบดิบไปอาหารพร้อมทาน', status: '', observations: '' },
    { id: '7.3', section: 'การป้องกันการปนเปื้อนข้าม', description: 'มีการติดป้ายหรือแนวทางสำหรับจัดการสารก่อภูมิแพ้อย่างชัดเจนและปลอดภัย', status: '', observations: '' },
  ]);

  // State for the calculated score
  const [score, setScore] = useState(0);

  // Helper function to get current date for initial display
  const getCurrentDate = () => {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
    const dd = String(today.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  };

  // Set initial date on component mount
  useEffect(() => {
    setAuditInfo(prev => ({ ...prev, date: getCurrentDate() }));
  }, []);

  // Handle changes in audit info fields
  const handleAuditInfoChange = (e) => {
    const { name, value } = e.target;
    setAuditInfo(prev => ({ ...prev, [name]: value }));
  };

  // Handle status change for a checklist item (Yes/No/NA)
  const handleStatusChange = (id, newStatus) => {
    setChecklistItems(prevItems =>
      prevItems.map(item =>
        item.id === id ? { ...item, status: newStatus } : item
      )
    );
  };

  // Handle observations change for a checklist item
  const handleObservationChange = (id, newObservation) => {
    setChecklistItems(prevItems =>
      prevItems.map(item =>
        item.id === id ? { ...item, observations: newObservation } : item
      )
    );
  };

  // Calculate the score whenever checklistItems change
  useEffect(() => {
    let yesCount = 0;
    let applicableCount = 0;

    checklistItems.forEach(item => {
      if (item.status === 'yes') {
        yesCount++;
        applicableCount++;
      } else if (item.status === 'no') {
        applicableCount++;
      }
      // If status is 'na', it's not counted in applicableCount
    });

    if (applicableCount > 0) {
      setScore(((yesCount / applicableCount) * 100).toFixed(2));
    } else {
      setScore(0);
    }
  }, [checklistItems]);

  // Utility to group items by section for rendering
  const groupedItems = checklistItems.reduce((acc, item) => {
    if (!acc[item.section]) {
      acc[item.section] = [];
    }
    acc[item.section].push(item);
    return acc;
  }, {});


  // Tailwind CSS classes for consistent styling
  const inputClass = "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm";
  const textareaClass = "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm resize-y";
  const labelClass = "block text-sm font-medium text-gray-700";
  const checkboxGroupClass = "flex flex-wrap gap-x-4"; // Adjusted for better wrapping on smaller screens
  const checkboxLabelClass = "flex items-center text-sm text-gray-700"; // Adjusted text size
  const checkboxInputClass = "h-4 w-4 text-amber-600 focus:ring-amber-500 border-gray-300 rounded";

  return (
    <div className="min-h-screen bg-gray-50 font-inter text-gray-800 flex justify-center py-8 px-4 sm:px-6 lg:px-8">
      <div className="max-w-4xl w-full bg-white shadow-xl rounded-lg p-8 space-y-8">
        {/* Header */}
        <div className="flex justify-between items-center pb-6 border-b border-gray-200">
          <div className="font-chonburi text-3xl font-bold text-gray-900">
            ลงหม้อสุกี้ <span className="block text-sm font-inter font-normal text-gray-600">Food Safety Management</span>
          </div>
          <div className="text-right text-xs text-gray-500">
            <div><span className="font-semibold text-gray-700">เอกสาร:</span> FSHAC-001</div>
            <div><span className="font-semibold text-gray-700">หัวข้อ:</span> Food Safety Audit Checklist</div>
            <div><span className="font-semibold text-gray-700">เวอร์ชัน:</span> v1.0 | <span className="font-semibold text-gray-700">จัดทำเมื่อ:</span> 2025–08–21</div>
          </div>
        </div>

        {/* Title Band */}
        <div className="bg-gradient-to-br from-gray-900 to-gray-700 text-white p-6 rounded-md border-l-4 border-amber-500">
          <h1 className="text-3xl font-playfair-display font-semibold mb-2">Food Safety Audit Checklist</h1>
          <p className="text-lg font-outfit text-gray-200">รายการตรวจสอบสุขอนามัยและความปลอดภัยอาหาร</p>
        </div>

        {/* Audit Information & Summary */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="bg-amber-50 p-6 rounded-lg border border-amber-200 shadow-sm">
            <h4 className="flex items-center font-bold text-sm text-amber-700 uppercase mb-4">
              <span className="text-xl mr-2">🔎</span>ข้อมูลการตรวจสอบ (Audit Information)
            </h4>
            <div className="space-y-4">
              <div>
                <label htmlFor="date" className={labelClass}>วันที่ตรวจสอบ:</label>
                <input type="date" id="date" name="date" value={auditInfo.date} onChange={handleAuditInfoChange} className={inputClass} />
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label htmlFor="startTime" className={labelClass}>เวลาเริ่มต้น:</label>
                  <input type="time" id="startTime" name="startTime" value={auditInfo.startTime} onChange={handleAuditInfoChange} className={inputClass} />
                </div>
                <div>
                  <label htmlFor="endTime" className={labelClass}>เวลาสิ้นสุด:</label>
                  <input type="time" id="endTime" name="endTime" value={auditInfo.endTime} onChange={handleAuditInfoChange} className={inputClass} />
                </div>
              </div>
              <div>
                <label htmlFor="auditor" className={labelClass}>ผู้ตรวจสอบ:</label>
                <input type="text" id="auditor" name="auditor" value={auditInfo.auditor} onChange={handleAuditInfoChange} className={inputClass} />
              </div>
            </div>
          </div>

          <div className="bg-amber-50 p-6 rounded-lg border border-amber-200 shadow-sm">
            <h4 className="flex items-center font-bold text-sm text-amber-700 uppercase mb-4">
              <span className="text-xl mr-2">📝</span>สรุปผลการตรวจสอบ (Audit Summary)
            </h4>
            <div className="space-y-4">
              <div>
                <label htmlFor="area" className={labelClass}>พื้นที่ที่ตรวจสอบ:</label>
                <input type="text" id="area" name="area" value={auditInfo.area} onChange={handleAuditInfoChange} className={inputClass} />
              </div>
              <div>
                <label className={labelClass}>ระดับความเสี่ยงที่พบ:</label>
                <div className={checkboxGroupClass}>
                  <label className={checkboxLabelClass}>
                    <input type="checkbox" name="riskLevel" value="high" checked={auditInfo.riskLevel === 'high'} onChange={handleAuditInfoChange} className={checkboxInputClass} />
                    สูง
                  </label>
                  <label className={checkboxLabelClass}>
                    <input type="checkbox" name="riskLevel" value="medium" checked={auditInfo.riskLevel === 'medium'} onChange={handleAuditInfoChange} className={checkboxInputClass} />
                    ปานกลาง
                  </label>
                  <label className={checkboxLabelClass}>
                    <input type="checkbox" name="riskLevel" value="low" checked={auditInfo.riskLevel === 'low'} onChange={handleAuditInfoChange} className={checkboxInputClass} />
                    ต่ำ
                  </label>
                </div>
              </div>
              <div>
                <label htmlFor="overallSuggestions" className={labelClass}>ข้อเสนอแนะโดยรวม:</label>
                <textarea id="overallSuggestions" name="overallSuggestions" rows="3" value={auditInfo.overallSuggestions} onChange={handleAuditInfoChange} className={textareaClass}></textarea>
              </div>
              {/* Score Display */}
              <div className="mt-6 p-4 bg-green-100 border border-green-300 rounded-md text-center text-lg font-semibold text-green-800">
                คะแนนความสอดคล้อง: <span className="text-2xl font-bold">{score}%</span>
              </div>
            </div>
          </div>
        </div>

        {/* Checklist Details */}
        <section className="mt-8">
          <h2 className="text-2xl font-playfair-display font-semibold text-gray-900 pb-3 mb-6 border-b border-gray-200">
            รายละเอียดรายการตรวจสอบ (Checklist Details)
          </h2>
          <p className="text-base text-gray-700 mb-6">
            ตรวจสอบรายการด้านล่างนี้ และระบุสถานะการปฏิบัติตาม พร้อมบันทึกข้อสังเกตและแผนการแก้ไข
          </p>

          <div className="overflow-x-auto"> {/* Added for horizontal scrolling on small screens */}
            <table className="min-w-full divide-y divide-gray-200 border border-gray-200">
              <thead className="bg-amber-100">
                <tr>
                  <th scope="col" className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider w-1/2">
                    รายการตรวจสอบ (Checklist Item)
                  </th>
                  <th scope="col" className="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider w-1/5">
                    สถานะ
                  </th>
                  <th scope="col" className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider w-1/4">
                    ข้อสังเกต / การดำเนินการแก้ไข (Observations / Corrective Actions)
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {Object.keys(groupedItems).map(section => (
                  <React.Fragment key={section}>
                    <tr>
                      <td colSpan="3" className="p-0 border-none">
                        <h3 className="bg-amber-50 py-3 px-4 text-base font-bold text-amber-800 flex items-center border-b border-amber-300">
                          {section.startsWith('1.') ? <span className="text-lg mr-2">🚚</span> :
                           section.startsWith('2.') ? <span className="text-lg mr-2">👨‍🍳</span> :
                           section.startsWith('3.') ? <span className="text-lg mr-2">🚶</span> :
                           section.startsWith('4.') ? <span className="text-lg mr-2">🧼</span> :
                           section.startsWith('5.') ? <span className="text-lg mr-2">🗑️</span> :
                           section.startsWith('6.') ? <span className="text-lg mr-2">🌡️</span> :
                           section.startsWith('7.') ? <span className="text-lg mr-2">🧬</span> : <span className="text-lg mr-2">📋</span>}
                          {section}
                        </h3>
                      </td>
                    </tr>
                    {groupedItems[section].map(item => (
                      <tr key={item.id}>
                        <td className="px-4 py-3 align-top text-sm text-gray-900 border-r border-gray-200">
                          {item.id} {item.description}
                        </td>
                        <td className="px-4 py-3 align-top text-center border-r border-gray-200">
                          <div className="flex flex-col sm:flex-row justify-center items-center gap-2">
                            <label className={checkboxLabelClass}>
                              <input
                                type="checkbox"
                                name={`status-${item.id}`}
                                value="yes"
                                checked={item.status === 'yes'}
                                onChange={() => handleStatusChange(item.id, 'yes')}
                                className={checkboxInputClass}
                              />
                              ใช่
                            </label>
                            <label className={checkboxLabelClass}>
                              <input
                                type="checkbox"
                                name={`status-${item.id}`}
                                value="no"
                                checked={item.status === 'no'}
                                onChange={() => handleStatusChange(item.id, 'no')}
                                className={checkboxInputClass}
                              />
                              ไม่ใช่
                            </label>
                            <label className={checkboxLabelClass}>
                              <input
                                type="checkbox"
                                name={`status-${item.id}`}
                                value="na"
                                checked={item.status === 'na'}
                                onChange={() => handleStatusChange(item.id, 'na')}
                                className={checkboxInputClass}
                              />
                              NA
                            </label>
                          </div>
                        </td>
                        <td className="px-4 py-3 align-top">
                          <textarea
                            rows="2"
                            value={item.observations}
                            onChange={(e) => handleObservationChange(item.id, e.target.value)}
                            className={textareaClass}
                          ></textarea>
                        </td>
                      </tr>
                    ))}
                  </React.Fragment>
                ))}
              </tbody>
            </table>
          </div>
        </section>

        {/* Signatures */}
        <section className="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8 text-sm text-gray-800">
          <div>
            <div className="border-t border-dashed border-gray-400 pt-4">
              ผู้ตรวจสอบ: <span className="inline-block w-3/4 border-b border-gray-300"></span><br/>
              ตำแหน่ง: <span className="inline-block w-3/4 border-b border-gray-300"></span><br/>
              วันที่: <span className="inline-block w-3/4 border-b border-gray-300"></span>
            </div>
          </div>
          <div>
            <div className="border-t border-dashed border-gray-400 pt-4">
              ผู้รับรองการแก้ไข: <span className="inline-block w-3/4 border-b border-gray-300"></span><br/>
              ตำแหน่ง: <span className="inline-block w-3/4 border-b border-gray-300"></span><br/>
              วันที่: <span className="inline-block w-3/4 border-b border-gray-300"></span>
            </div>
          </div>
        </section>
      </div>
    </div>
  );
};

export default App;
