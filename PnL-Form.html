<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Restaurant Budget Form — R&B Transolution</title>
  <style>
    :root{
      /* R&B Transolution palette */
      --deep:#0b2f25;   /* deep green */
      --bg:#0b2f25;     /* background deep green */
      --bg-2:#113a2d;   /* panel deep green */
      --ink:#ffffff;    /* white */
      --muted:#9aa3ab;  /* grey */
      --gold:#c7a047;   /* gold */
      --line:#2a3f36;   /* divider grey/green */
      --accent:#0f241d; /* hover darker */
      --black:#000000;  /* black */
      --grey:#9aa3ab;   /* grey alias */
      --bad:#b91c1c;    /* error */
      --good:#166534;   /* success */
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 "Inter",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:20px;margin:0;color:var(--gold)}
    .badge{background:transparent;color:var(--gold);border:1px solid var(--gold);padding:6px 10px;border-radius:999px;font-size:12px}
    .card{background:var(--bg-2);border:1px solid var(--gold);border-radius:12px;padding:14px;box-shadow:0 0 0 1px rgba(199,160,71,0.15) inset}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0}
    button{appearance:none;border:1px solid var(--gold);background:transparent;color:var(--ink);padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    button:hover{background:var(--accent)}
    button.secondary{border-color:var(--line)}
    button.danger{border-color:var(--bad);color:#fee2e2}
    .hint{color:var(--muted);font-size:12px}
    .scroll{overflow:auto;border:1px solid var(--line);border-radius:12px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:1024px}
    th,td{border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:6px 8px;vertical-align:middle}
    th:first-child,td:first-child{border-left:1px solid var(--line)}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,#12211b,#0f201a)}
    thead .month{font-weight:700;text-align:center}
    thead .sub{font-weight:600;font-size:12px;color:var(--muted)}
    tbody tr.section>td{background:#10261f;font-weight:700;color:var(--gold)}
    tbody tr.total>td:first-child{font-weight:700}
    input[type="number"]{width:110px;box-sizing:border-box;background:transparent;border:1px solid var(--line);color:var(--ink);border-radius:8px;padding:6px 8px;text-align:right}
    .money{text-align:right;display:inline-block;min-width:90px}
    .sticky-left{position:sticky;left:0;background:var(--bg-2);z-index:3;box-shadow:1px 0 0 var(--line)}
    .footer{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    a.inline{color:var(--gold)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Restaurant Budget (Jan–Dec)</h1>
      <span class="badge">R&B Transolution • Budget v1.2</span>
    </header>

    <div class="card">
      <div class="controls">
        <button id="seedDummy" class="secondary">Seed demo data</button>
        <button id="clearAll" class="danger">Clear all</button>
        <button id="downloadCsv">Download CSV</button>
        <button id="printView" class="secondary">Print</button>
        <button id="runTests" class="secondary">Run self‑tests</button>
      </div>
      <div class="hint">Inputs: <strong>Guests</strong>, <strong>Avg CHK Food</strong>, <strong>Avg CHK Bev</strong>, <strong>Other Revenue</strong>, <strong>Food/Bev %</strong>, <strong>Other Cost</strong>, and <strong>all expense lines</strong>. Everything else auto-calculates. Full Year totals compute from the 12 months; ratio rows display as proper percentages.</div>
    </div>

    <div class="scroll" style="margin-top:14px">
      <table id="pnlTable"></table>
    </div>

    <div class="footer hint">
      <span>Palette: Gold, Deep Green, White, Black, Grey. Percentages show with a % sign; money shows with thousands separators.</span>
    </div>
  </div>

<script>
(function(){
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const table = document.getElementById('pnlTable');

  const ROWS = [
    {type:'section', label:'Revenue'},
    {id:'guests', label:'Number of Guests', input:'number'},
    {id:'avg_food', label:'Avg CHK Food', input:'money'},
    {id:'avg_bev', label:'Avg CHK Bev', input:'money'},
    {id:'rev_other', label:'Other Revenue', input:'money'},
    {id:'rev_food', label:'Food Revenue (Guests × Avg CHK Food)', calc:'money'},
    {id:'rev_bev', label:'Beverage Revenue (Guests × Avg CHK Bev)', calc:'money'},
    {id:'rev_total', label:'Total Revenue', calc:'money', total:true},

    {type:'section', label:'Cost of Sale'},
    {id:'pct_food', label:'Food Cost % (0–100)', input:'percent'},
    {id:'cos_food', label:'Food Cost Amount', calc:'money'},
    {id:'pct_bev', label:'Beverage Cost % (0–100)', input:'percent'},
    {id:'cos_bev', label:'Beverage Cost Amount', calc:'money'},
    {id:'cos_other', label:'Other Cost (Amount)', input:'money'},
    {id:'cos_total', label:'Total Cost of Sale', calc:'money', total:true},
    {id:'cos_ratio', label:'COS % of Revenue', calc:'ratio'},

    {type:'section', label:'Gross Profit'},
    {id:'gp', label:'Gross Profit', calc:'money'},
    {id:'gp_ratio', label:'Gross Profit %', calc:'ratio'},

    {type:'section', label:'Operating Expenses'},
  ];

  const defaultExpenses = [
    'Labor Cost & Related (Wages, SSO, Benefits)','Guest Supplies','Utilities (Electricity/Water/Gas)','Rent & Lease','Marketing & Advertising','Repairs & Maintenance','Cleaning & Sanitation','Office Supplies','Uniforms & Laundry','Bank Fees','Credit Card Fees','Delivery Platform Commissions','Delivery & Courier','Transportation & Travel','Recruitment & Training','Insurance','Licenses & Permits','IT & Software (POS/SaaS)','Internet & Phone','Security','Waste Disposal','Smallwares & Replacements','Printing & Stationery','Professional Fees (Accounting/Legal)','Other Operating Expenses'
  ];

  function buildTable(){
    table.innerHTML = '';

    // Header
    const thead = document.createElement('thead');
    const tr1 = document.createElement('tr');
    const th0 = document.createElement('th'); th0.className='sticky-left'; th0.textContent='Category'; tr1.appendChild(th0);
    months.forEach(m=>{const th=document.createElement('th'); th.className='month'; th.textContent=m; tr1.appendChild(th)});
    const thFY = document.createElement('th'); thFY.textContent='Full Year'; tr1.appendChild(thFY);
    thead.appendChild(tr1);

    const tr2 = document.createElement('tr');
    const th00 = document.createElement('th'); th00.className='sticky-left sub'; th00.textContent=''; tr2.appendChild(th00);
    months.forEach(()=>{const th=document.createElement('th'); th.className='sub'; th.textContent='Amount'; tr2.appendChild(th)});
    const thFY2 = document.createElement('th'); thFY2.className='sub'; thFY2.textContent='Total'; tr2.appendChild(thFY2);
    thead.appendChild(tr2);

    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    // Pre-expense rows
    for(const r of ROWS){
      if(r.type==='section'){
        const tr = document.createElement('tr'); tr.className='section';
        const td = document.createElement('td'); td.className='sticky-left'; td.colSpan=months.length+2; td.textContent=r.label; tr.appendChild(td); tbody.appendChild(tr);
      } else {
        tbody.appendChild(buildRow(r.id, r.label, r.input, r.calc, !!r.total));
      }
    }

    // Expense rows
    expenseRows.forEach((name, idx)=> tbody.appendChild(buildExpenseRow(idx, name)) );

    // Opex totals and GOP
    tbody.appendChild(buildRow('opex_total','Total Operating Expenses', null,'money', true,'total'));
    tbody.appendChild(buildRow('opex_ratio','Opex % of Revenue', null,'ratio', false,'total'));
    tbody.appendChild(sectionBreak('Operating Profit (GOP)'));
    tbody.appendChild(buildRow('gop','GOP', null,'money', false,'total'));
    tbody.appendChild(buildRow('gop_ratio','GOP % of Revenue', null,'ratio', false,'total'));

    table.appendChild(tbody);
  }

  function sectionBreak(title){
    const tr = document.createElement('tr'); tr.className='section';
    const td = document.createElement('td'); td.className='sticky-left'; td.colSpan=months.length+2; td.textContent=title; tr.appendChild(td); return tr;
  }

  function buildRow(id, label, inputType, calcType, fullYearSum=false, extraClass=''){
    const tr = document.createElement('tr'); if(extraClass) tr.classList.add(extraClass);
    const left = document.createElement('td'); left.className='sticky-left'; left.textContent=label; tr.appendChild(left);
    months.forEach((m,mi)=>{
      const td=document.createElement('td');
      if(inputType){
        const inp=document.createElement('input'); inp.type='number'; inp.step='0.01'; inp.className='money'; inp.dataset.key=`${id}_${mi}`; td.appendChild(inp);
      } else {
        const span=document.createElement('span'); span.className='money'; span.dataset.key=`${id}_${mi}`; span.textContent='0'; td.appendChild(span);
      }
      tr.appendChild(td);
    });
    const fy=document.createElement('td'); const fySpan=document.createElement('span'); fySpan.className='money'; fySpan.dataset.key=`${id}_fy`; fySpan.textContent='0'; fy.appendChild(fySpan); tr.appendChild(fy);
    tr.dataset.id=id; tr.dataset.calc=calcType||''; tr.dataset.sum=fullYearSum?'1':'0';
    return tr;
  }

  function buildExpenseRow(idx, name){
    const tr=document.createElement('tr');
    const left=document.createElement('td'); left.className='sticky-left';
    const nameInput=document.createElement('input'); nameInput.type='text'; nameInput.value=name; nameInput.dataset.expenseIndex=idx; nameInput.addEventListener('input', ()=>{ expenseRows[idx]=nameInput.value; });
    left.appendChild(nameInput); tr.appendChild(left);
    months.forEach((m,mi)=>{
      const td=document.createElement('td'); const inp=document.createElement('input'); inp.type='number'; inp.step='0.01'; inp.className='money'; inp.dataset.key=`exp_${idx}_${mi}`; td.appendChild(inp); tr.appendChild(td);
    });
    const fy=document.createElement('td'); const fySpan=document.createElement('span'); fySpan.className='money'; fySpan.dataset.key=`exp_${idx}_fy`; fySpan.textContent='0'; fy.appendChild(fySpan); tr.appendChild(fy);
    tr.dataset.expenseIndex=idx; return tr;
  }

  // State
  let expenseRows=[...defaultExpenses];

  // Helpers
  function num(v){ const n=parseFloat(v); return isNaN(n)?0:n; }
  function fmtMoney(n){ return Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2}); }
  function fmtPercent(n){ return (Number(n||0)*100).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})+"%"; }
  function getVal(key){ const el=document.querySelector(`[data-key="${key}"]`); if(!el) return 0; return el.tagName==='INPUT'? num(el.value): num(el.textContent); }
  function setMoney(key,val){ const el=document.querySelector(`[data-key="${key}"]`); if(!el) return; if(el.tagName==='INPUT'){ el.value=val; } else { el.textContent=fmtMoney(val); } }
  function setPercent(key,val){ const el=document.querySelector(`[data-key="${key}"]`); if(!el) return; if(el.tagName==='INPUT'){ el.value=val; } else { el.textContent=fmtPercent(val); } }

  function recalc(){
    for(let mi=0; mi<12; mi++){
      const guests = getVal(`guests_${mi}`);
      const avgFood = getVal(`avg_food_${mi}`);
      const avgBev  = getVal(`avg_bev_${mi}`);
      const otherRev = getVal(`rev_other_${mi}`);
      const foodRev = guests*avgFood;
      const bevRev  = guests*avgBev;
      const totalRev = foodRev+bevRev+otherRev;
      setMoney(`rev_food_${mi}`, foodRev);
      setMoney(`rev_bev_${mi}`, bevRev);
      setMoney(`rev_total_${mi}`, totalRev);

      const pctFood = getVal(`pct_food_${mi}`)/100;
      const pctBev  = getVal(`pct_bev_${mi}`)/100;
      const cosFood = foodRev*pctFood;
      const cosBev  = bevRev *pctBev;
      const cosOther= getVal(`cos_other_${mi}`);
      const cosTotal= cosFood+cosBev+cosOther;
      setMoney(`cos_food_${mi}`, cosFood);
      setMoney(`cos_bev_${mi}`,  cosBev);
      setMoney(`cos_total_${mi}`, cosTotal);
      setPercent(`cos_ratio_${mi}`, totalRev? (cosTotal/totalRev):0);

      const gp = totalRev-cosTotal;
      setMoney(`gp_${mi}`, gp);
      setPercent(`gp_ratio_${mi}`, totalRev? (gp/totalRev):0);

      // OPEX
      let opex=0; for(let ei=0; ei<expenseRows.length; ei++){ opex += getVal(`exp_${ei}_${mi}`); }
      setMoney(`opex_total_${mi}`, opex);
      setPercent(`opex_ratio_${mi}`, totalRev? (opex/totalRev):0);

      const gop = gp-opex;
      setMoney(`gop_${mi}`, gop);
      setPercent(`gop_ratio_${mi}`, totalRev? (gop/totalRev):0);
    }

    // FY totals & FY ratios
    document.querySelectorAll('#pnlTable tbody tr').forEach(tr=>{
      const id = tr.dataset.id; if(!id) return;
      const calc = tr.dataset.calc;
      if(calc==='ratio'){
        const map={ cos_ratio:['cos_total','rev_total'], gp_ratio:['gp','rev_total'], opex_ratio:['opex_total','rev_total'], gop_ratio:['gop','rev_total'] };
        if(map[id]){
          const numFY = sumFY(map[id][0]);
          const denFY = sumFY(map[id][1]);
          setPercent(`${id}_fy`, denFY? (numFY/denFY):0);
        }
      } else {
        setMoney(`${id}_fy`, sumFY(id));
      }
    });

    // Expense FY
    for(let ei=0; ei<expenseRows.length; ei++) setMoney(`exp_${ei}_fy`, sumFY(`exp_${ei}`));
  }

  function sumFY(base){ let s=0; for(let mi=0; mi<12; mi++){ s += getVal(`${base}_${mi}`); } return s; }

  function attachHandlers(){ table.addEventListener('input', e=>{ if(e.target && e.target.matches('input')) recalc(); }); }

  function toCSV(){
    const rows=[]; rows.push(['Category',...months,'Full Year']);
    function pushRow(label, id){ const line=[label]; for(let mi=0; mi<12; mi++){ const el=document.querySelector(`[data-key="${id}_${mi}"]`); line.push(el? (el.tagName==='INPUT'? el.value: el.textContent):''); } const fy=document.querySelector(`[data-key="${id}_fy"]`); line.push(fy? fy.textContent:''); rows.push(line); }
    document.querySelectorAll('#pnlTable tbody tr').forEach(tr=>{
      if(tr.classList.contains('section')){ rows.push([tr.textContent]); return; }
      const id = tr.dataset.id; const label = tr.querySelector('td.sticky-left').innerText.trim();
      if(id) pushRow(label,id); else if(tr.dataset.expenseIndex){ const idx=tr.dataset.expenseIndex; const name=tr.querySelector('td.sticky-left input').value; pushRow(name,`exp_${idx}`); }
    });
    // Use regex replace for broader browser support instead of String.replaceAll
    const csv = rows.map(r=>r.map(x=> '"' + String(x).replace(/"/g,'""') + '"').join(',')).join('\n');
    return csv;
  }

  function download(filename, text){ const blob=new Blob([text],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000); }

  function seedDemo(){
    for(let mi=0; mi<12; mi++){
      document.querySelector(`[data-key="guests_${mi}"]`).value = 1500 + mi*20;
      document.querySelector(`[data-key="avg_food_${mi}"]`).value = 380;
      document.querySelector(`[data-key="avg_bev_${mi}"]`).value  = 140;
      document.querySelector(`[data-key="rev_other_${mi}"]`).value = 15000;
      document.querySelector(`[data-key="pct_food_${mi}"]`).value = 33;
      document.querySelector(`[data-key="pct_bev_${mi}"]`).value  = 28;
      document.querySelector(`[data-key="cos_other_${mi}"]`).value = 8000;
      for(let ei=0; ei<expenseRows.length; ei++){
        const base = ei===0? 450000 : (ei<5? 30000 : 8000);
        const el = document.querySelector(`[data-key="exp_${ei}_${mi}"]`); if(el) el.value = base;
      }
    }
    recalc();
  }

  function clearAll(){ document.querySelectorAll('#pnlTable input').forEach(inp=> inp.value=''); document.querySelectorAll('#pnlTable [data-key$="_fy"]').forEach(s=> s.textContent='0'); recalc(); }

  function printView(){ window.print(); }

  // --- Minimal Self Tests ---
  function assert(cond, msg){ if(!cond){ throw new Error(msg||'Assertion failed'); } }
  function runTests(){
    try{
      clearAll();
      // Seed a tiny deterministic scenario in Jan
      document.querySelector('[data-key="guests_0"]').value = 100;
      document.querySelector('[data-key="avg_food_0"]').value = 200; // 20,000
      document.querySelector('[data-key="avg_bev_0"]').value  = 50;  // 5,000
      document.querySelector('[data-key="rev_other_0"]').value = 1000; // +1,000
      document.querySelector('[data-key="pct_food_0"]').value = 25; // 25%
      document.querySelector('[data-key="pct_bev_0"]').value  = 20; // 20%
      document.querySelector('[data-key="cos_other_0"]').value = 100;
      recalc();

      // Check derived values (not visible in UI, but computed)
      const totalRevJan = getVal('rev_total_0');
      assert(Math.abs(totalRevJan - 26000) < 0.001, 'Total Revenue Jan should be 26,000');

      const csv = toCSV();
      assert(csv.includes('"Category"'), 'CSV should include quoted header');
      assert(csv.indexOf('\n') !== -1, 'CSV should contain newlines');

      alert('Self-tests passed.');
    }catch(e){
      console.error(e);
      alert('Self-tests failed: ' + e.message);
    }
  }

  // Init
  buildTable();
  attachHandlers();
  recalc();

  // Buttons
  document.getElementById('seedDummy').onclick = seedDemo;
  document.getElementById('clearAll').onclick = clearAll;
  document.getElementById('downloadCsv').onclick = ()=> download('restaurant_budget.csv', toCSV());
  document.getElementById('printView').onclick = printView;
  document.getElementById('runTests').onclick = runTests;
})();
</script>
</body>
</html>
